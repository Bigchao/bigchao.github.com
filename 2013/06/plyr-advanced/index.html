<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
                <meta property="wb:webmaster" content="397a4c282ef1bdba" />
		<meta name="description" content="Plyr- 多因子整合 | 技术改变世界">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Plyr- 多因子整合</title>
		<!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/assets/ie.html"><![endif]-->
		<link rel="shortcut icon" href="/assets/images/favicon.ico" />
		<link rel="stylesheet" type="text/css" href="/assets/stylesheets/style.css">
		<script type="text/javascript">
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-45407331-1']);
			_gaq.push(['_trackPageview']);
			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	"		})();
		</script>
		
	</head>
	<body>
		<nav id="nav">
		    <a href="/index.html"><img id="profile" src="/assets/images/profile.png" alt="" height="100" width="100"></a>
			<ul id="menu">
				<li id="label1" class="label selected"><span>最新文章</span></li>
				<li id="label2" class="label"><span>机器学习</span></li>
				<li id="label3" class="label"><span>数据可视化</span></li>
				<li id="label4" class="label"><span>数据挖掘</span></li>
				<li id="label5" class="label"><span>其他技术</span></li>
				<li id="label6" class="label"><span>生活随笔</span></li>
				<a id="about" href="/index.html">关于我</a>
			</ul>

		</nav>

		<aside id="sidebar">
			<div id="title_wrap" class="select1">
				<h2 id="title1" class="title">最新文章</h2>
				<h2 id="title2" class="title">机器学习</h2>
				<h2 id="title3" class="title">数据可视化</h2>
				<h2 id="title4" class="title">数据挖掘</h2>
				<h2 id="title5" class="title">其他技术</h2>
				<h2 id="title6" class="title">生活随笔</h2>
			</div>

			<div id="post_list">
			
				<a class="datavis cate1" href="/2013/11/ggplot2-2d-density"><span class="circle_icon"></span>ggplot2 - 二维数据密度图<span class="date">Nov 2013</span></a>
			
				<a class="datavis cate1" href="/2013/09/Significance-ggplot2"><span class="circle_icon"></span>ggplot2 - 为拟合曲线加置信空间<span class="date">Sep 2013</span></a>
			
				<a class="datamining cate1" href="/2013/06/plyr-advanced"><span class="circle_icon"></span>Plyr- 多因子整合<span class="date">Jun 2013</span></a>
			
				<a class="datavis cate1" href="/2013/05/stack-area-ggplot2"><span class="circle_icon"></span>ggplot2 - Stacked Area Graph<span class="date">May 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/Wilkinson-Dot-Plot"><span class="circle_icon"></span>ggplot2 - Wilkinson Dot Plot<span class="date">Apr 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/heat-map"><span class="circle_icon"></span>ggplot2 - Heat Map<span class="date">Apr 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/cleveland-Dotplot"><span class="circle_icon"></span>ggplot2 - Cleveland Dot Plot<span class="date">Apr 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/ggplot2-line-graph"><span class="circle_icon"></span>ggplot2 - Line Graph<span class="date">Apr 2013</span></a>
			
				<a class="datamining cate1" href="/2013/03/plyr-dataming"><span class="circle_icon"></span>Plyr- 数据整合利器<span class="date">Mar 2013</span></a>
			
				<a class="datavis cate1" href="/2013/02/ggplot2-histogram"><span class="circle_icon"></span>ggplot2 - Histogram<span class="date">Feb 2013</span></a>
			
				<a class="datamining cate1" href="/2013/02/reshape-advanced"><span class="circle_icon"></span>R - Reshape Package II<span class="date">Feb 2013</span></a>
			
				<a class="datamining cate1" href="/2013/02/reshape-basic"><span class="circle_icon"></span>R - Reshape2 Package<span class="date">Feb 2013</span></a>
			
				<a class="datavis cate1" href="/2013/02/ggplot2-bar-chart"><span class="circle_icon"></span>ggplot2 - Barchart<span class="date">Feb 2013</span></a>
			
				<a class="datavis cate1" href="/2013/01/intro-ggplot2"><span class="circle_icon"></span>ggplot2 - 作图哲学<span class="date">Jan 2013</span></a>
			
				<a class="datavis cate1" href="/2013/01/welcome-ggplot2"><span class="circle_icon"></span>ggplot2 - Welcome!<span class="date">Jan 2013</span></a>
			
			</div>
		</aside>

		<div id="container">
			<div id="pjax">
				
				<article id="post">
	<header id="header">
		<h1 id="identifier">Plyr- 多因子整合</h1>
		<button id="fullscreen" class="header_icon"></button>
		<button id="fontsize" class="header_icon"></button>
	</header>
	<div id="content">
		<p>在上次我们看到的例子，Iris数据集中只有Species一个是因子 （factor），其实plyr更加适合于在多因子的数据集中进行操作</p>

<p>今天我们用一个稍微复杂一点的数据集来详细讲解</p>

<ul>
<li><a href="https://github.com/hadley/data-baby-names/blob/master/baby-names.csv">babynames</a></li>
</ul>


<p>原数据大约2万5千行，包括四个字段year，name，pecent，sex。其中year是从1880到2008</p>

<div class="highlight"><pre><code class="r">    
    options<span class="p">(</span>stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    babyname <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;bnames.csv&quot;</span><span class="p">)</span>
    head<span class="p">(</span>babyname<span class="p">)</span>
</code></pre></div>


<p>数据就是这个样子的</p>

<pre>
  year    name      percent     sex
1 1880    John      0.081541    boy
2 1880 William      0.080511    boy
3 1880   James      0.050057    boy
4 1880 Charles      0.045167    boy
5 1880  George      0.043292    boy
6 1880   Frank      0.027380    boy
</pre>


<p><strong>问题1</strong>： 找到每一年，每种性别中最受欢迎的名字</p>

<p>还是按照我们的SAC思想</p>

<p>S：把原数据按照sex和year两个因子进行切片</p>

<p>A：每个切片中得到最受欢迎的名字</p>

<p>C：把结果整合</p>

<div class="highlight"><pre><code class="r">    
    ddply<span class="p">(</span>babyname<span class="p">,</span> .<span class="p">(</span>year<span class="p">,</span> sex<span class="p">),</span> <span class="o">?????</span><span class="p">)</span>
</code></pre></div>


<p>前两部份我们都已经很熟悉了，原数据切片。但是后面得到最受欢迎的名字应该怎么办？</p>

<p>我们要自定义一个函数，来求出最受欢迎的人名，然后再把它加到ddply中的function里面</p>

<div class="highlight"><pre><code class="r">    
    mostPopular <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
    x<span class="o">$</span>name<span class="p">[</span>which.max<span class="p">(</span>x<span class="o">$</span>percent<span class="p">)]</span>
    <span class="p">}</span>
    ddply<span class="p">(</span>babyname<span class="p">,</span> .<span class="p">(</span>year<span class="p">,</span> sex<span class="p">),</span> mostPopular<span class="p">)</span>
</code></pre></div>


<p>结果一下就出来了（截取）</p>

<pre>
   year  sex       V1
1   1880  boy     John
2   1880 girl     Mary
3   1881  boy     John
4   1881 girl     Mary
5   1882  boy     John
6   1882 girl     Mary
7   1883  boy     John
8   1883 girl     Mary
9   1884  boy     John
10  1884 girl     Mary
11  1885  boy     John
12  1885 girl     Mary
13  1886  boy     John
14  1886 girl     Mary
15  1887  boy     John
16  1887 girl     Mary
17  1888  boy     John
18  1888 girl     Mary
19  1889  boy     John
20  1889 girl     Mary
</pre>


<p>可以看出，1889年，都是男的叫John最多，女的叫Mary最多。</p>

<p><strong>问题2</strong>：每一年，每种性别中 （ 作者注： 这就是告诉你怎么切片呢 ）， 名字的首字母所占比例是多少？</p>

<p>解释下问题： Get the total percentage of the first character of the baby names by year and gender</p>

<p>就比如2000年一共15个男孩出生，5个叫杨超，5个叫贾超，5个叫牛超</p>

<p>那Y（Yang）的首字母占比是 1/3
同理 J （Jia ） 和 N （Niu ）也是 1/3</p>

<p>还是SAC思想</p>

<p>S： 按照性别、年份选出进行切片。
<strong>注意！</strong> 这里不仅仅是要对这两个变量进行切片，还有自定义一个新的变量 <code>姓名的首字母</code>！</p>

<p>请在反思上面的简单引例。</p>

<p>A： 对同样的首字母百分比进行加和</p>

<p>C： 数据整合</p>

<div class="highlight"><pre><code class="r">    
    <span class="c1">#首先提取名字的首字母</span>
    firstletter <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
    tolower<span class="p">(</span>substr<span class="p">(</span>x<span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1"># 根据ddply可以得出结果</span>
    letterFreq <span class="o">&lt;-</span> ddply<span class="p">(</span>babyname<span class="p">,</span> .<span class="p">(</span>year<span class="p">,</span> sex<span class="p">,</span> first<span class="o">=</span>firstletter<span class="p">(</span>name<span class="p">)),</span> summarize<span class="p">,</span> sumPer <span class="o">=</span> sum<span class="p">(</span>percent<span class="p">))</span>
</code></pre></div>


<p>最后的结果就是这样的</p>

<pre>
  year sex  first   sumPer
1 1880 boy     a    0.062543
2 1880 boy     b    0.017858
3 1880 boy     c    0.084047
4 1880 boy     d    0.021010
5 1880 boy     e    0.058219
6 1880 boy     f    0.055142
</pre>


<p>最后我们可以可视化一下，用到ggplot2</p>

<div class="highlight"><pre><code class="r">    
    require<span class="p">(</span>ggplot2<span class="p">)</span>
    ggplot<span class="p">(</span>letterFreq<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>year<span class="p">,</span> y<span class="o">=</span>sumPer<span class="p">,</span> group<span class="o">=</span>sex<span class="p">))</span> <span class="o">+</span> geom_line<span class="p">(</span>aes<span class="p">(</span>color<span class="o">=</span>sex<span class="p">))</span> <span class="o">+</span> facet_wrap<span class="p">(</span><span class="o">~</span> first<span class="p">,</span> nrow<span class="o">=</span><span class="m">3</span><span class="p">)</span>
</code></pre></div>


<p><img src="http://i.imgur.com/eQloL6A.png" alt="" /></p>

<p>在Hadley的官网上，有不少这样的例子，大家一定要多去看看，多感受就更有感觉了。</p>

<p>原文的数据，代码，最后的图在<a href="http://pan.baidu.com/s/19r800">这里</a></p>

		
		<div id="donation">
		欢迎<a href="https://me.alipay.com/bigchao">捐赠作者</a>,鼓励更多分享:)
		</div>
		<div id="social">
		    <a id="weibo" href="http://v.t.sina.com.cn/share/share.php?url=http://yangchao.me/2013/06/plyr-advanced&title=Plyr- 多因子整合"></a>
			<a id="twitter" href="https://twitter.com/intent/tweet?url=http://yangchao.me/2013/06/plyr-advanced&text=Plyr- 多因子整合"></a>
			<a id="end_cc" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"></a>
		</div>
	</div>
</article>

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>



			</div>
		</div>

		<div id="notice">左右滑动</div>
		<script type="text/javascript" src="/assets/js/jquery.js"></script>
		<script type="text/javascript" src="/assets/js/jquery.pjax.js"></script>
		<script type="text/javascript" src="/assets/js/script.js"></script>
		<script type="text/javascript">
		$(document).ready(function(){
        $("#profile").click(function(){
		$.get("sitemap.xml",function(data){
		 var $xml=$(data);
		 url=$xml.find("url")
		 n = url.size()
		 n = getRandom(n)
		 position=url.get(n)
		 location.href =position.find("loc").text()
	
  })
	
})
	//随机数发生器
       function getRandom(n){return Math.floor(Math.random()*(n+1))}
});
		</script>
		
	</body>
</html>
