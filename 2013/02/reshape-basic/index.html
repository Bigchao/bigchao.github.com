<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
                <meta property="wb:webmaster" content="397a4c282ef1bdba" />
		<meta name="description" content="R - Reshape2 Package | 技术改变世界">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>R - Reshape2 Package</title>
		<!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/assets/ie.html"><![endif]-->
		<link rel="shortcut icon" href="/assets/images/favicon.ico" />
		<link rel="stylesheet" type="text/css" href="/assets/stylesheets/style.css">
		<script type="text/javascript">
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-45407331-1']);
			_gaq.push(['_trackPageview']);
			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	"		})();
		</script>
		
	</head>
	<body>
		<nav id="nav">
		    <a id="random" href="#"><img id="profile" src="/assets/images/profile.png" alt="" height="100" width="100"></a>
			<ul id="menu">
				<li id="label1" class="label selected"><span>最新文章</span></li>
				<li id="label2" class="label"><span>机器学习</span></li>
				<li id="label3" class="label"><span>数据可视化</span></li>
				<li id="label4" class="label"><span>数据挖掘</span></li>
				<li id="label5" class="label"><span>其他技术</span></li>
				<li id="label6" class="label"><span>生活随笔</span></li>
				<a id="about" href="/index.html">关于我</a>
			</ul>

		</nav>

		<aside id="sidebar">
			<div id="title_wrap" class="select1">
				<h2 id="title1" class="title">最新文章</h2>
				<h2 id="title2" class="title">机器学习</h2>
				<h2 id="title3" class="title">数据可视化</h2>
				<h2 id="title4" class="title">数据挖掘</h2>
				<h2 id="title5" class="title">其他技术</h2>
				<h2 id="title6" class="title">生活随笔</h2>
			</div>

			<div id="post_list">
			
				<a class="datavis cate1" href="/2013/11/ggplot2-2d-density"><span class="circle_icon"></span>ggplot2 - 二维数据密度图<span class="date">Nov 2013</span></a>
			
				<a class="datavis cate1" href="/2013/10/latticeextra-horizon-applied"><span class="circle_icon"></span>latticeExtra - Horizon Chart - 应用<span class="date">Oct 2013</span></a>
			
				<a class="datavis cate1" href="/2013/10/horizon-lattice-extra"><span class="circle_icon"></span>latticeExtra - Horizon Plot的简单实现<span class="date">Oct 2013</span></a>
			
				<a class="datavis cate1" href="/2013/10/horizon-plot"><span class="circle_icon"></span>Horizon Chart - 惊艳到爆的哲学<span class="date">Oct 2013</span></a>
			
				<a class="datavis cate1" href="/2013/09/Significance-ggplot2"><span class="circle_icon"></span>ggplot2 - 为拟合曲线加置信空间<span class="date">Sep 2013</span></a>
			
				<a class="datamining cate1" href="/2013/06/plyr-advanced"><span class="circle_icon"></span>Plyr- 多因子整合<span class="date">Jun 2013</span></a>
			
				<a class="datavis cate1" href="/2013/05/stack-area-ggplot2"><span class="circle_icon"></span>ggplot2 - Stacked Area Graph<span class="date">May 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/Wilkinson-Dot-Plot"><span class="circle_icon"></span>ggplot2 - Wilkinson Dot Plot<span class="date">Apr 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/heat-map"><span class="circle_icon"></span>ggplot2 - Heat Map<span class="date">Apr 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/cleveland-Dotplot"><span class="circle_icon"></span>ggplot2 - Cleveland Dot Plot<span class="date">Apr 2013</span></a>
			
				<a class="datavis cate1" href="/2013/04/ggplot2-line-graph"><span class="circle_icon"></span>ggplot2 - Line Graph<span class="date">Apr 2013</span></a>
			
				<a class="datamining cate1" href="/2013/03/plyr-dataming"><span class="circle_icon"></span>Plyr- 数据整合利器<span class="date">Mar 2013</span></a>
			
				<a class="datavis cate1" href="/2013/02/ggplot2-histogram"><span class="circle_icon"></span>ggplot2 - Histogram<span class="date">Feb 2013</span></a>
			
				<a class="datamining cate1" href="/2013/02/reshape-advanced"><span class="circle_icon"></span>R - Reshape Package II<span class="date">Feb 2013</span></a>
			
				<a class="datamining cate1" href="/2013/02/reshape-basic"><span class="circle_icon"></span>R - Reshape2 Package<span class="date">Feb 2013</span></a>
			
				<a class="datavis cate1" href="/2013/02/ggplot2-bar-chart"><span class="circle_icon"></span>ggplot2 - Barchart<span class="date">Feb 2013</span></a>
			
				<a class="datavis cate1" href="/2013/01/intro-ggplot2"><span class="circle_icon"></span>ggplot2 - 作图哲学<span class="date">Jan 2013</span></a>
			
				<a class="datavis cate1" href="/2013/01/welcome-ggplot2"><span class="circle_icon"></span>ggplot2 - Welcome!<span class="date">Jan 2013</span></a>
			
				<a class="life cate1" href="/2012/08/story-vision"><span class="circle_icon"></span>自己的视角，别人的故事<span class="date">Aug 2012</span></a>
			
				<a class="life cate1" href="/2012/06/memorize-michael-jackson"><span class="circle_icon"></span>纪念 Michael Jacson - 一颗纯真的心<span class="date">Jun 2012</span></a>
			
				<a class="life cate1" href="/2012/06/happy-madives"><span class="circle_icon"></span>传说中的马尔代夫<span class="date">Jun 2012</span></a>
			
			</div>
		</aside>

		<div id="container">
			<div id="pjax">
				
				<article id="post">
	<header id="header">
		<h1 id="identifier">R - Reshape2 Package</h1>
		<button id="fullscreen" class="header_icon"></button>
		<button id="fontsize" class="header_icon"></button>
	</header>
	<div id="content">
		<p>在之前介绍GGPLOT2的时候就提到过，数据分析和可视化之前的数据清理非常重要，Reshape2可以提供强大的帮助。</p>

<p>这次主要想介绍下这个Package, 作者同样是R大神Hadley Wickham，他还写过其他16个R拓展包，其中最有名的要算是ggplot2 和pylr了。
Reshape2可谓非常强大，用到的最多的Melt(),和Cast() 两个函数</p>

<p>Reshape2是原作者在5年之后重写的，更加提高效率。语法并没有太大改变，所以如果看到了reshape的教程，大家也可以看下，其实是通用的。</p>

<p>首先介绍下Melt()函数，通俗易懂的理解就是，如果不加任何参数，就是把原来的data.frame只变成三列，id，variable，value.</p>

<p>举个例子理解下
Smiths数据集原来是这样的
 <pre> subject time    age    weight  height
1 John Smith    1       33     90   1.87
2 Mary Smith    1       NA     NA   1.54</pre></p>

<p>我们来melt一下</p>

<div class="highlight"><pre><code class="r">    
    melt<span class="p">(</span>smiths<span class="p">)</span>
</code></pre></div>


<p>出来的结果就是这样的了</p>

<pre>     subject variable value
1 John Smith     time  1.00
2 Mary Smith     time  1.00
3 John Smith      age 33.00
4 Mary Smith      age    NA
5 John Smith   weight 90.00
6 Mary Smith   weight    NA
7 John Smith   height  1.87
8 Mary Smith   height  1.54
</pre>


<p><br></br></p>

<p>大家发现了什么？是不是就是先按住第一列不要动，然后第二列的列名变成了新建变量variabe的值，然后原来第二列的值变成了第三列新建变量value的值，然后后边的列都以此类推？</p>

<p>最浅显易懂就是这么理解了。
当然，Melt()函数可以改变的参数很多，官方给出的参数在这里</p>

<div class="highlight"><pre><code class="r">    melt<span class="p">(</span>data<span class="p">,</span> <span class="o">&lt;</span>span style<span class="o">=</span><span class="s">&quot;color: #ff0000;&quot;</span><span class="o">&gt;</span>id.vars<span class="o">&lt;/</span>span<span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span>span style<span class="o">=</span><span class="s">&quot;color: #ff0000;&quot;</span><span class="o">&gt;</span> measure.vars<span class="o">&lt;/</span>span<span class="o">&gt;</span><span class="p">,</span>
    variable.name <span class="o">=</span> <span class="s">&quot;variable&quot;</span><span class="p">,</span> <span class="kc">...</span><span class="p">,</span> na.rm <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
    value.name <span class="o">=</span> <span class="s">&quot;value&quot;</span><span class="p">)</span>
</code></pre></div>


<p>注意上面，</p>

<ul>
<li>id.vars是说指定id的，用id可以代替id.vars，也就是例子中的subject这一列</li>
<li>measure.vars是指所有原数据中，除了id.vars的所有列, 可以用measured代替measure.vars</li>
<li>variable.name是指定新建variable这一列的列名的</li>
<li>na.rm = TRUE 的用法是原来数据中如包含空值，新建数据集将NA的行全部删除</li>
<li>value.name是指定新建变量value这一列的列名</li>
</ul>


<p>感受下下面一段代码</p>

<div class="highlight"><pre><code class="r">    melt1 <span class="o">&lt;-</span> melt<span class="p">(</span>smiths<span class="p">,</span>id<span class="o">=</span>c<span class="p">(</span><span class="s">&quot;subject&quot;</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">),</span>variable.name<span class="o">=</span>c<span class="p">(</span><span class="s">&quot;newvar&quot;</span><span class="p">),</span>value.name<span class="o">=</span>c<span class="p">(</span><span class="s">&quot;newval&quot;</span><span class="p">))</span>
</code></pre></div>


<p>我们重新指定了id为subject和time两个。</p>

<pre> subject      time newvar newval
1 John Smith    1    age  33.00
2 Mary Smith    1    age     NA
3 John Smith    1 weight  90.00
4 Mary Smith    1 weight     NA
5 John Smith    1 height   1.87
6 Mary Smith    1 height   1.54</pre>


<p><br></br>
这样是不是非常方便把数据揉来揉去了？：）</p>

<p>下面介绍下cast()函数
如果说melt把数据变长，那么cast就把数据变宽。在Reshape2 Package中显而易见的一点不同是cast()函数变成了</p>

<ul>
<li>dcast，针对data.frame</li>
<li>acast()，针对array</li>
<li>因为我们用的最多的就是data.frame,所以推荐这个。 array可以提高更多的维度。</li>
</ul>


<p>下面给出cast的用法，用英文原文更能保留其中的原汁原味，我也懒得再绞尽脑汁想如何翻译了。</p>

<ul>
<li>data： the molten data set to reshape</li>
<li>formula: the casting formula which describes the shape of the output format (if you omit this argument, cast will return the data frame in the classic form with measured variables in the columns, and all other id variables in the rows)</li>
<li>fun.aggregate: aggregation function to use, if necessary</li>
<li>margins: what marginal values should be computed</li>
</ul>


<p>其中的第二段太难理解了，说白了就是你想怎么molten data重新整成什么样。 所谓的fomula其实就是这样的：col_var_1 + col_var_2 ~ row_var_1 + row_var_2</p>

<ul>
<li>大家现在可以停下来想一想，cast的过程就是把原来的melt的逆过程，</li>
<li>其中“~” 这个符号就是分隔符</li>
<li>也就是说在 ~ 之前是留着不懂的，~之后指示为在原来“row_var_1”这一列所有的值都变成了单独列。</li>
<li>有时候于遇到 "..."符号，表示fomula中所有没有用到的vector都在此。"."表示在后面没有任何的数据列</li>
</ul>


<div class="highlight"><pre><code class="r">    cast<span class="p">(</span>ffm<span class="p">,</span> treatment <span class="o">+</span> rep <span class="o">~</span> .<span class="p">,</span> length<span class="p">)</span>
    <span class="c1">#表示在分别统计treatment，和rep两个变量的频度</span>
    <span class="c1">#主要感受下 &quot;.&quot; 的用法 </span>
    相当于SQL语句里面的
    select treatment，rep count（<span class="o">*</span>） as length
    from ffm    
    group by treatment<span class="p">,</span> rep<span class="p">;</span>
</code></pre></div>


<p>举个例子！
刚才已经建立了一个melt1的数据集，现在我们想把它还原</p>

<div class="highlight"><pre><code class="r">    
    <span class="o">&gt;</span> dcast<span class="p">(</span>melt1<span class="p">,</span> time <span class="o">+</span> subject <span class="o">~</span> newvar<span class="p">)</span>    
    
</code></pre></div>


<p>这样就可以还原到了，在逗号后面的就是所谓的fomula。
看第二个例子</p>

<div class="highlight"><pre><code class="r">    <span class="o">&gt;</span> dcast<span class="p">(</span>melt1<span class="p">,</span> <span class="kc">...</span> <span class="o">~</span> subject<span class="p">)</span>
    <span class="c1"># 感受下&quot;...&quot; 的用法</span>
</code></pre></div>


<p>这回用到了...的用法，另外还有把数据框</p>

<pre>  time newvar John Smith Mary Smith
1    1    age      33.00         NA
2    1 weight      90.00         NA
3    1 height       1.87       1.54 </pre>


<p><br></br>
关于第一二点，不知道这样大家是否可以理解了呢？</p>

<p>其中第三点和第四点稍微举了例子大家就能理解了</p>

<div class="highlight"><pre><code class="r">    
    <span class="c1">#用到airquality数据集</span>
    names<span class="p">(</span>airquality<span class="p">)</span> <span class="o">&lt;-</span> tolower<span class="p">(</span>names<span class="p">(</span>airquality<span class="p">))</span>
    因为列名中包含大小写，所以为了书写方便全部用tolower<span class="p">()</span>函数改成小写
    aqm <span class="o">&lt;-</span> melt<span class="p">(</span>airquality<span class="p">,</span> id<span class="o">=</span>c<span class="p">(</span><span class="s">&quot;month&quot;</span><span class="p">,</span> <span class="s">&quot;day&quot;</span><span class="p">),</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
    dcast<span class="p">(</span>aqm<span class="p">,</span> month <span class="o">~</span> variable<span class="p">,</span> mean<span class="p">,</span> 
    <span class="o">+</span> margins <span class="o">=</span> c<span class="p">(</span><span class="s">&quot;month&quot;</span><span class="p">,</span> <span class="s">&quot;variable&quot;</span><span class="p">))</span>
</code></pre></div>


<p>其实就是根据每月的各个variable求了个平均值，特别像数据透视表</p>

<pre> 
  month    ozone  solar.r      wind     temp    (all)
1     5 23.61538 181.2963 11.622581 65.54839 68.70696
2     6 29.44444 190.1667 10.266667 79.10000 87.38384
3     7 59.11538 216.4839  8.941935 83.90323 93.49748
4     8 59.96154 171.8571  8.793548 83.96774 79.71207
5     9 31.44828 167.4333 10.180000 76.90000 71.82689
6 (all) 42.12931 185.9315  9.957516 77.88235 80.05722</pre>


<p><br></br></p>

<p>当然这个拓展包中还有其他若干好用的函数，有兴趣的话可以看看下面两个文档</p>

<ul>
<li><p>官方的文档链接在: <a href="cran.r-project.org/web/packages/reshape2/reshape2.pdf%E2%80%8E">这里</a></p></li>
<li><p>作者同样写过一篇发表在Journal of Statistical Software的论文，比官方文档写的更加清楚一点。链接在: <a href="http://www.jstatsoft.org/v21/i12/paper">这里</a> 强烈推荐这篇论文，看完之后就会觉得通透了！</p></li>
</ul>


		
		<div id="donation">
		欢迎<a href="https://me.alipay.com/bigchao">捐赠作者</a>,鼓励更多分享:)
		</div>
		<div id="social">
		    <a id="weibo" href="http://v.t.sina.com.cn/share/share.php?url=http://yangchao.me/2013/02/reshape-basic&title=R - Reshape2 Package"></a>
			<a id="twitter" href="https://twitter.com/intent/tweet?url=http://yangchao.me/2013/02/reshape-basic&text=R - Reshape2 Package"></a>
			<a id="end_cc" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"></a>
		</div>
	</div>
</article>

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>



			</div>
		</div>

		<div id="notice">左右滑动</div>
		<script type="text/javascript" src="/assets/js/jquery.js"></script>
		<script type="text/javascript" src="/assets/js/jquery.pjax.js"></script>
		<script type="text/javascript" src="/assets/js/script.js"></script>
		<script>
		$(document).ready(function(){
		$("#random").on('click','img',function(){
			$.get("sitemap.xml",function(data){
			var $xml=$(data);
			url=$xml.find("url");
			n = url.size();
			n = getRandom(n);
			position=url.get(n);  
			hello=position.getElementsByTagName("loc")[0].firstChild.nodeValue; 
			location.href=hello;
		})
    
	})
  //随机数发生器
       function getRandom(n){return Math.floor(Math.random()*(n+1))}
})
	</script>
		
	</body>
</html>
